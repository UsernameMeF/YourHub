{% extends 'base.html' %}
{% load static %}

{% block title %}Мои друзья и запросы{% endblock %}

{% block content %}
<div class="friends-list-container"> {# Добавьте CSS классы для стилизации #}
    <h2>Мои друзья и запросы</h2>

    {# --- Навигация между списками (Друзья / Запросы) --- #}
    <div class="friends-nav"> {# Класс для кнопок переключения #}
        <button class="nav-button active" data-target="friends">Друзья ({{ friends|length }})</button>
        <button class="nav-button" data-target="received-requests">Входящие запросы ({{ received_requests|length }})</button>
        <button class="nav-button" data-target="sent-requests">Отправленные запросы ({{ sent_requests|length }})</button>
    </div>

    {# TODO: Место для сообщений об успехе/ошибке AJAX #}
    {# Сообщения будут отображаться здесь после выполнения AJAX запроса #}
    <div id="ajax-messages" class="ajax-messages-container"></div>

    {# --- Секция "Друзья" --- #}
    <div id="friends" class="friends-section"> {# Класс для секции друзей #}
        <h3>Список друзей</h3>
        {% if friends %}
            <ul class="friends-grid"> {# Добавьте классы для сетки друзей #}
                {% for friend in friends %}
                    <li class="friend-item"> {# Класс для каждого элемента друга #}
                        {# Ссылка на профиль друга #}
                        <a href="{% url 'user_profile' friend.id %}">
                            {# Аватар друга (доступ к профилю через related_name) #}
                            <img src="{% if friend.profile and friend.profile.avatar %}{{ friend.profile.avatar.url }}{% else %}{% static 'images/default-avatar.png' %}{% endif %}" alt="{{ friend.username }} Аватар" class="friend-avatar">
                            <span class="friend-username">{{ friend.username }}</span>
                        </a>
                        {# <form method="post" action="{% url 'remove_friend' user_id=friend.id %}" class="ajax-remove-friend-form" data-user-id="{{ friend.id }}" style="display:inline;"> {% csrf_token %} <button type="submit">Удалить</button> </form> #}
                    </li>
                {% endfor %}
            </ul>
            {# TODO: Добавить пагинацию для списка друзей #}
        {% else %}
            <p>У вас пока нет друзей.</p>
        {% endif %}
    </div>

    {# --- Секция "Входящие запросы на дружбу" --- #}
    {# id секции изменен для уникальности #}
    <div id="received-requests" class="friends-section hidden"> {# По умолчанию скрыта, будет показываться через JS #}
        <h3>Входящие запросы</h3>
        {% if received_requests %}
            <ul class="request-list"> {# Класс для списка запросов #}
                {% for request in received_requests %}
                    {# Каждому элементу запроса присваиваем уникальный ID для удобства удаления через JS #}
                    <li class="request-item" id="request-{{ request.id }}">
                        {# Ссылка на профиль отправителя запроса #}
                        <a href="{% url 'user_profile' request.from_user.id %}">
                             {# Аватар отправителя #}
                            <img src="{% if request.from_user.profile and request.from_user.profile.avatar %}{{ request.from_user.profile.avatar.url }}{% else %}{% static 'images/default-avatar.png' %}{% endif %}" alt="{{ request.from_user.username }} Аватар" class="request-avatar">
                            <span class="request-username">{{ request.from_user.username }}</span>
                        </a>
                        <div class="request-actions"> {# Контейнер для кнопок действий с запросом #}
                            {# Форма для принятия запроса - с классом для AJAX #}
                            <form method="post" action="{% url 'accept_friend_request' friendship_id=request.id %}" class="ajax-friend-request-form" data-request-id="{{ request.id }}" style="display:inline;">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-success">Принять</button>
                            </form>
                            {# Форма для отклонения запроса - с классом для AJAX #}
                            <form method="post" action="{% url 'decline_friend_request' friendship_id=request.id %}" class="ajax-friend-request-form" data-request-id="{{ request.id }}" style="display:inline;">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-danger">Отклонить</button>
                            </form>
                        </div>
                    </li>
                {% endfor %}
            </ul>
            {# TODO: Добавить пагинацию для списка запросов #}
        {% else %}
            <p>У вас нет входящих запросов на дружбу.</p>
        {% endif %}
    </div>

    {# --- Секция "Отправленные запросы" --- #}
     {% if sent_requests %} {# Показываем секцию только если есть отправленные запросы #}
         <div id="sent-requests" class="friends-section hidden">
            <h3>Отправленные запросы</h3>
            {% if sent_requests %}
                <ul class="request-list">
                    {% for request in sent_requests %}
                         {# Каждому элементу запроса присваиваем уникальный ID для удобства удаления через JS #}
                        <li class="request-item" id="request-{{ request.id }}">
                            {# Ссылка на профиль получателя запроса #}
                            <a href="{% url 'user_profile' request.to_user.id %}">
                                {# Аватар получателя #}
                                <img src="{% if request.to_user.profile and request.to_user.profile.avatar %}{{ request.to_user.profile.avatar.url }}{% else %}{% static 'images/default-avatar.png' %}{% endif %}" alt="{{ request.to_user.username }} Аватар" class="request-avatar">
                                <span class="request-username">{{ request.to_user.username }}</span>
                            </a>
                            <div class="request-actions">
                                {#- Ожидает подтверждения#}
                                {# Форма для отмены запроса - с классом для AJAX #}
                                <form method="post" action="{% url 'cancel_friend_request' friendship_id=request.id %}" class="ajax-friend-request-form" data-request-id="{{ request.id }}" style="display:inline;">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-danger">Отменить</button>
                                </form>
                            </div>
                        </li>
                    {% endfor %}
                </ul>
                {# TODO: Добавить пагинацию для списка отправленных запросов #}
            {% else %}
                <p>У вас нет отправленных запросов на дружбу.</p>
            {% endif %}
         </div>
     {% endif %}


</div>

{% block extra_js %}
<script>
    // JavaScript для переключения между секциями "Друзья" и "Запросы"
    document.addEventListener('DOMContentLoaded', function() {
        const navButtons = document.querySelectorAll('.friends-nav .nav-button');
        const sections = document.querySelectorAll('.friends-list-container .friends-section');
        // Собираем все формы с классом 'ajax-friend-request-form'
        const ajaxForms = document.querySelectorAll('.ajax-friend-request-form');
        const ajaxMessagesDiv = document.getElementById('ajax-messages');

        // Функция для показа определенной секции
        function showSection(targetId) {
             // Удаляем активный класс со всех кнопок и добавляем к текущей
            navButtons.forEach(btn => {
                if (btn.getAttribute('data-target') === targetId) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });

            // Скрываем все секции и показываем целевую
            sections.forEach(section => section.classList.add('hidden'));
            const targetSection = document.getElementById(targetId);
            if (targetSection) {
                 targetSection.classList.remove('hidden');
            }
        }

        // Обработчики кликов для кнопок навигации
        navButtons.forEach(button => {
            button.addEventListener('click', function() {
                const target = this.getAttribute('data-target');
                showSection(target);
            });
        });

        // Добавляем базовый стиль для скрытия (если еще не добавлен в общий CSS)
        // Это гарантирует, что секции будут скрыты до загрузки JS
        const style = document.createElement('style');
        style.innerHTML = '.hidden { display: none; }';
        document.head.appendChild(style);

        // Показываем секцию "Друзья" по умолчанию при загрузке
        showSection('friends');


        // --- AJAX для форм запросов на дружбу ---
        ajaxForms.forEach(form => {
            form.addEventListener('submit', function(event) {
                event.preventDefault(); // Предотвращаем стандартную отправку формы

                const form = event.target;
                const actionUrl = form.action; // URL для отправки запроса
                const method = form.method; // Метод (POST)
                const formData = new FormData(form); // Собираем данные формы (включая CSRF токен)
                const requestId = form.getAttribute('data-request-id'); // ID запроса из атрибута data-*

                // Выполняем асинхронный запрос с помощью Fetch API
                fetch(actionUrl, {
                    method: method,
                    body: formData,
                    // Заголовок X-CSRFToken обычно не нужен при использовании FormData,
                    // так как токен отправляется в теле запроса.
                    // Но если возникнут проблемы, можно раскомментировать и использовать getCookie
                    // headers: { 'X-CSRFToken': getCookie('csrftoken') }
                })
                .then(response => {
                    // Проверяем статус ответа (успех 2xx или ошибка)
                    if (!response.ok) {
                        // Если статус не 2xx, парсим JSON ошибки и бросаем исключение
                        return response.json().then(errorData => {
                             throw new Error(errorData.message || 'Произошла ошибка.');
                        });
                    }
                    // Если статус 2xx, парсим JSON ответ
                    return response.json();
                })
                .then(data => {
                    // Обрабатываем успешный ответ от сервера (статус 'success' из нашего JsonResponse)
                    if (data.status === 'success') {
                        // Находим элемент списка (<li>) соответствующего запроса по его ID
                        const requestItem = document.getElementById(`request-${data.request_id}`);
                        if (requestItem) {
                            requestItem.remove(); // Удаляем элемент из DOM

                            // TODO: Опционально: обновить счетчики запросов/друзей на кнопках навигации
                            updateCounts(); // Вызываем функцию обновления счетчиков
                            displayMessage(data.message, 'success'); // Показать сообщение об успехе
                        }
                    } else {
                         // Обрабатываем ответ со статусом 'error' из нашего JsonResponse
                         displayMessage(data.message || 'Произошла ошибка.', 'error'); // Показать сообщение об ошибке
                    }
                })
                .catch(error => {
                    // Обрабатываем ошибки сети или ошибки, брошенные в .then
                    console.error('AJAX error:', error);
                    displayMessage(error.message || 'Произошла ошибка при выполнении действия.', 'error');
                });
            });
        });

        // TODO: Функция для получения CSRF токена из куки (если потребуется)
        /*
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    // Does this cookie string begin with the name we want?
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        */

        // Функция для отображения сообщений пользователю в блоке #ajax-messages
        function displayMessage(message, type) {
            const messageElement = document.createElement('div');
            // Добавляем CSS классы для стилизации (нужно определить в style.css)
            messageElement.classList.add('ajax-message', `ajax-message-${type}`);
            messageElement.textContent = message;

            // Очищаем предыдущие сообщения перед добавлением нового
            ajaxMessagesDiv.innerHTML = '';
            ajaxMessagesDiv.appendChild(messageElement);

            // Опционально: автоматически скрывать сообщение через несколько секунд
            setTimeout(() => {
                if (ajaxMessagesDiv.contains(messageElement)) {
                     messageElement.remove();
                }
            }, 5000); // Сообщение исчезнет через 5 секунд
        }

        // TODO: Функция для обновления счетчиков на кнопках навигации после AJAX действия
        // Это может быть более сложным, т.к. требует пересчета элементов или получения новых данных
        // Для начала можно не реализовывать или просто пересчитывать видимые элементы
        function updateCounts() {
             // Пример (очень простой пересчет видимых элементов в секции):
             const friendsCount = document.getElementById('friends').querySelectorAll('.friend-item').length;
             const receivedRequestsCount = document.getElementById('received-requests').querySelectorAll('.request-item').length;
             const sentRequestsSection = document.getElementById('sent-requests');
             const sentRequestsCount = sentRequestsSection ? sentRequestsSection.querySelectorAll('.request-item').length : 0;


             document.querySelector('.friends-nav button[data-target="friends"]').textContent = `Друзья (${friendsCount})`;
             document.querySelector('.friends-nav button[data-target="received-requests"]').textContent = `Входящие запросы (${receivedRequestsCount})`;
             const sentRequestsButton = document.querySelector('.friends-nav button[data-target="sent-requests"]');
             if (sentRequestsButton) {
                 sentRequestsButton.textContent = `Отправленные запросы (${sentRequestsCount})`;
                 // Если отправленных запросов 0, можно скрыть кнопку
                 if (sentRequestsCount === 0) {
                     sentRequestsButton.style.display = 'none';
                 } else {
                      sentRequestsButton.style.display = ''; // Или 'inline-block', в зависимости от стилей
                 }
             }

             // TODO: Учесть, что при принятии запроса, пользователь добавляется в список друзей.
             // Это потребует добавления элемента в список друзей через JS или полного обновления списков.
             // Более надежный подход - получать обновленные списки или их части с сервера после действия.
        }

    });
</script>
{% endblock %}

{% endblock %}