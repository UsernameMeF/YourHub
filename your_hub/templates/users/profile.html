{# users/templates/users/profile.html #}
{% extends 'base.html' %}
{% load static %}

{% block title %}{{ viewed_user.username }} Profile{% endblock %}

{% block extra_head %}
    <link rel="stylesheet" href="{% static 'css/users/_profile.css' %}">
    <link rel="stylesheet" href="{% static 'css/users/_profile_dark.css' %}">
    {# Убедитесь, что Font Awesome подключен в base.html или здесь #}
    {# Пример подключения Font Awesome (если еще нет в base.html): #}
    {# <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"> #}
{% endblock %}

{% block content %}
    <div class="profile-container">
        <div class="profile-header-top">
            <h2>Профиль</h2>
            <div class="profile-actions-top">
                {% if is_my_profile %}
                    <a href="{% url 'users:edit_profile' %}" class="btn-primary">Редактировать профиль</a>
                {% else %}
                    {# Проверяем статус дружбы для отображения кнопок #}
                    {% include 'profile_actions_snippet.html' %}
                {% endif %}
            </div>
        </div>

        <div class="profile-header">
            {# Контейнер для аватара и статуса #}
            <div class="profile-avatar-wrapper">
                <img src="{{ user_profile.avatar.url }}" alt="Аватар {{ viewed_user.username }}" class="profile-avatar-large">
                
                {# Иконка статуса #}
                <div class="status-indicator status-{{ actual_status }}" 
                     data-current-status="{{ user_profile.status }}" 
                     {% if is_my_profile %}id="my-status-indicator"{% endif %}>
                     <i class="status-icon"></i> 
                </div>

                {# Выпадающее меню статусов (видимо только для своего профиля) #}
                {% if is_my_profile %}
                <div class="status-dropdown" id="status-dropdown">
                    <div class="status-option" data-status="online">
                        <i class="status-dot fas fa-circle status-online"></i> В сети
                    </div>
                    <div class="status-option" data-status="away">
                        <i class="status-dot fas fa-moon status-away"></i> Неактивен
                    </div>
                    <div class="status-option" data-status="dnd">
                        <i class="status-dot fas fa-minus-circle status-dnd"></i> Не беспокоить
                    </div>
                    <div class="status-option" data-status="invisible">
                        <i class="status-dot fas fa-circle status-invisible"></i> Невидимый
                    </div>
                </div>
                {% endif %}
            </div>

            <div class="profile-info">
                <h3>@{{ viewed_user.username }}</h3>
                <p>Дата регистрации: {{ viewed_user.date_joined|date:"d.m.Y" }}</p>
                {% if user_profile.bio %}
                    <p>О себе: {{ user_profile.bio }}</p>
                {% endif %}
            </div>
        </div>

        <div class="profile-sections">
            <div class="profile-section">
                <h3>Друзья ({{ user_friends.count }})</h3>
                {% if user_friends %}
                    <ul>
                        {% for friend in user_friends %}
                            <li><a href="{% url 'users:user_profile' friend.id %}">{{ friend.username }}</a></li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <p>{{ viewed_user.username }} пока не имеет друзей.</p>
                {% endif %}
            </div>

            <div class="profile-section">
                <h3>Последняя публикация</h3>
                {% if latest_post %}
                    <a href="{{ latest_post.get_absolute_url }}" class="latest-post-link">
                        <div class="latest-post-card">
                            <h4>{{ latest_post.title }}</h4>
                            <p>{{ latest_post.content|truncatechars:200 }}</p> {# Отображаем часть контента #}
                            <span class="post-date">Опубликовано: {{ latest_post.created_at|date:"d.m.Y H:i" }}</span>
                        </div>
                    </a>
                {% else %}
                    <p class="no-posts-message">У пользователя пока нет публикаций.</p>
                {% endif %}
            </div>

            {% comment %} <div class="profile-section">
                <h3>Активность</h3>
                {% if user_activity %}
                    {# TODO: Отображение активности #}
                    <ul>
                        {% for activity in user_activity %}
                            <li>{{ activity.description }}</li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <p>Последней активности нет.</p>
                {% endif %}
            </div> {% endcomment %}
        </div>
    </div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- НАЧАЛО: JavaScript для обновления СТАТУСА пользователя (ваш существующий код) ---
    const statusIndicator = document.querySelector('.profile-avatar-wrapper .status-indicator');
    const statusIcon = statusIndicator ? statusIndicator.querySelector('.status-icon') : null;
    
    function updateStatusIcon(displayStatus) { 
        if (!statusIcon) return;
        statusIcon.className = 'status-icon fas'; 
        if (!statusIndicator) return; // Добавлена проверка для statusIndicator
        statusIndicator.className = 'status-indicator status-' + displayStatus;
        if (displayStatus === 'online') {
            statusIcon.classList.add('fa-circle');
        } else if (displayStatus === 'away') {
            statusIcon.classList.add('fa-moon');
        } else if (displayStatus === 'dnd') {
            statusIcon.classList.add('fa-minus-circle');
        } else if (displayStatus === 'invisible' || displayStatus === 'offline') {
            statusIcon.classList.add('fa-circle');
        }
    }

    if (statusIndicator) { // Проверяем, что statusIndicator существует
        const initialDisplayStatusClass = Array.from(statusIndicator.classList).find(cls => cls.startsWith('status-') && cls !== 'status-indicator');
        const initialDisplayStatus = initialDisplayStatusClass ? initialDisplayStatusClass.replace('status-', '') : '{{ actual_status }}';
        updateStatusIcon(initialDisplayStatus); 
    }

    {% if is_my_profile %}
    const statusDropdown = document.getElementById('status-dropdown');
    const statusOptions = statusDropdown ? statusDropdown.querySelectorAll('.status-option') : null;
    // CSRF токен для AJAX-запросов статуса (убедитесь, что он корректно передается, если не используется FormData)
    const csrfTokenForStatus = document.querySelector('[name=csrfmiddlewaretoken]') ? document.querySelector('[name=csrfmiddlewaretoken]').value : '{{ csrf_token }}';


    if (statusIndicator && statusDropdown && statusOptions) {
        statusIndicator.addEventListener('click', function(event) {
            event.stopPropagation();
            statusDropdown.classList.toggle('active');
        });

        document.addEventListener('click', function(event) {
            if (statusDropdown && !statusDropdown.contains(event.target) && !statusIndicator.contains(event.target)) {
                statusDropdown.classList.remove('active');
            }
        });

        statusOptions.forEach(option => {
            option.addEventListener('click', function() {
                const newChosenStatus = this.dataset.status;
                fetch('{% url "users:set_user_status" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': csrfTokenForStatus
                    },
                    body: `status_type=${newChosenStatus}`
                })
                .then(response => {
                    if (!response.ok) {
                        return response.text().then(text => { throw new Error(text || 'Ошибка ответа сервера при обновлении статуса') });
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.status === 'success') {
                        updateStatusIcon(data.new_status);
                        if(statusIndicator) statusIndicator.dataset.currentStatus = data.chosen_status;
                        if(statusDropdown) statusDropdown.classList.remove('active');
                        console.log('Статус успешно обновлен до:', data.chosen_status, 'Отображаемый статус:', data.new_status);
                    } else {
                        console.error('Ошибка при обновлении статуса:', data.message);
                         displayMessage(data.message || 'Не удалось обновить статус.', 'error'); // Отображение ошибки пользователю
                    }
                })
                .catch(error => {
                    console.error('Ошибка AJAX запроса для статуса:', error);
                    displayMessage(error.message || 'Сетевая ошибка при обновлении статуса.', 'error');
                });
            });
        });
    }
    {% endif %} 
    // --- КОНЕЦ: JavaScript для обновления СТАТУСА пользователя ---


    // --- НАЧАЛО: JavaScript для AJAX-обработки ДЕЙСТВИЙ В ПРОФИЛЕ (из "старой версии", адаптированный) ---
    const profileActionsDiv = document.querySelector('.profile-actions-top'); // Обновленный селектор
    const ajaxMessagesDiv = document.getElementById('ajax-messages');     // Для отображения сообщений

    // Функция для отображения сообщений (из "старой версии" с небольшими улучшениями)
    function displayMessage(message, type) {
        if (!ajaxMessagesDiv) {
            console.warn("Элемент #ajax-messages не найден. Сообщение не будет отображено:", message);
            return;
        }
        if (!message || message.trim() === '') {
            ajaxMessagesDiv.innerHTML = ''; // Очищаем, если сообщение пустое
            return; 
        }
        const messageElement = document.createElement('div');
        messageElement.classList.add('ajax-message'); // Базовый класс для стилизации
        if (type) { // type это 'success', 'error', 'info' и т.д.
            messageElement.classList.add(`ajax-message-${type}`);
        } else {
            messageElement.classList.add('ajax-message-info'); // По умолчанию info, если тип не указан
        }
        messageElement.textContent = message;
        
        ajaxMessagesDiv.innerHTML = ''; // Заменяем предыдущее сообщение новым
        ajaxMessagesDiv.appendChild(messageElement);

        setTimeout(() => {
            if (ajaxMessagesDiv.contains(messageElement)) {
                messageElement.remove();
            }
        }, 5000); // Сообщение видно 5 секунд
    }
    
    function handleProfileFormSubmit(event) {
        event.preventDefault(); // Предотвращаем стандартную отправку формы
        const form = event.target;
        const actionUrl = form.action;
        const method = form.method;
        const formData = new FormData(form); // FormData автоматически включает CSRF-токен из формы

        fetch(actionUrl, {
            method: method,
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest' // Для Django, чтобы идентифицировать AJAX-запрос
            }
        })
        .then(response => {
            // Пытаемся получить JSON в любом случае, чтобы обработать сообщения об ошибках от сервера
            return response.json().then(data => ({
                ok: response.ok,      // boolean: true если статус 200-299
                data: data            // распарсенный JSON
            }));
        })
        .then(result => {
            const data = result.data; // JSON-ответ от сервера {status, message, new_button_html}
            
            if (!result.ok) { // Если HTTP статус НЕ успешный (например, 400, 403, 500)
                // Пытаемся использовать сообщение из JSON, если оно есть, иначе стандартное
                throw new Error(data.message || `Ошибка сервера: ${result.status_code}. Попробуйте позже.`);
            }

            // HTTP статус успешный (2xx)
            if (data.new_button_html && profileActionsDiv) {
                profileActionsDiv.innerHTML = data.new_button_html;
                attachSubmitListenersToNewForms(); // Переназначаем обработчики на новые формы
            }
            // Отображаем сообщение от сервера (если оно есть)
            // data.status это поле из JSON ('success', 'error', 'info')
            displayMessage(data.message, data.status); 
        })
        .catch(error => {
            console.error('Ошибка AJAX запроса для действий профиля:', error);
            displayMessage(error.message || 'Произошла ошибка. Пожалуйста, попробуйте еще раз.', 'error');
        });
    }

    function attachSubmitListenersToNewForms() {
        if (profileActionsDiv) { // Убедимся, что контейнер кнопок существует
            const newForms = profileActionsDiv.querySelectorAll('.ajax-profile-action-form');
            newForms.forEach(newForm => {
                // Удаляем предыдущий обработчик (если был) перед добавлением нового,
                // чтобы избежать многократного срабатывания на одной форме.
                newForm.removeEventListener('submit', handleProfileFormSubmit);
                newForm.addEventListener('submit', handleProfileFormSubmit);
            });
        }
    }

    // Первоначальное назначение обработчиков при загрузке страницы
    // Эта проверка важна, если .profile-actions-top может отсутствовать или быть пустым
    if (profileActionsDiv && profileActionsDiv.querySelector('.ajax-profile-action-form')) {
         attachSubmitListenersToNewForms();
    }
    // --- КОНЕЦ: JavaScript для AJAX-обработки ДЕЙСТВИЙ В ПРОФИЛЕ ---

});
</script>
{% endblock %}